---
title: "Communicating between R and WebVR sessions"
author: "Miles McBain"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

A live connection between an R session and a running scene being served by
`r2vr` is supported using a websocket API. This allows novel usage scenarios including:
* An 'operator' triggering events for a scene viewer using the R console 
  - Alternately using controls laid out in a html widget or shiny app.
* Streaming of data from R to VR scenes could be used create animations or
  dynamic visualisations

The communication layer is full duplex, meaning it is possible for events
triggered in VR to be relayed to the R session. When the websocket API is
enabled, the `scene` element has an event handler attached for A-Frame events of type
'r_server_message'. 'r_server_message' events are passed to the R server.

Ideally the onmessage handler would route the message to an entity based on id,
or the top level scene.

# Examples

## A console controlled 360 image slide show

For this example we'll add some 360 photos to a scene and allow them to be
stepped through by a console operator.

The images are hosted in an external GitHub repository:
https://github.com/MilesMcBain/360_image_examples. The code below reads them
directly from there.

### Scene setup

The following code creates asset objects from a list of supplied URLs, and then
sets up a scene containing a 'sky' sphere entity, `canvas_360`, that we can set
the internal texture of using its `src` component. The internal texture is
initially set to the first of the images.

```{r eval = FALSE}
library(r2vr)
library(purrr)

img_urls <-  c("https://ucarecdn.com/6cce6743-cfaa-4258-a93b-240e912c1ecc/",
               "https://ucarecdn.com/f2595d03-1a21-4ef8-9c07-6ef9a4972be7/",
               "https://ucarecdn.com/2f5030e8-a3c0-4045-ad84-a96ea25dfab0/",
               "https://ucarecdn.com/ef0090e4-703e-4edd-9527-42853eed9cfb/")

img_ids <- paste0("360img", seq(length(img_urls)))

img_assets <- map2(img_ids, img_urls, ~a_asset(id = .x,
                                               src = .y,
                                               tag = "img"))

canvas_360 <- a_entity(tag = "sky",
                       id = "canvas360",
                       position = c(0, 0, 0),
                       src = img_assets[[1]], ## src is the inital texture asset
                       .assets = img_assets   ## these are the assets we will change to
                       )

the_scene <- a_scene(title = "A 360 image slideshow",
                     template = "empty",
                     children = list(canvas_360),
                     websocket = TRUE) ## Enable coms with R server

the_scene$serve()
```

The images in this scene have a combined size of about ~25mb, so the scene will
need some time to load.

### Control from R
With the scene running we now turn our attention to writing an 'advance()'
function that we can call to advance to the next image in the list.

```{r eval = FALSE}

img_index <- 1
n_images <- length(img_ids)

advance <- function(){
    img_index <<- ifelse(test = img_index == n_images,
                         yes = 1,
                         no = img_index + 1)

    the_scene$send_messages(list(
                a_update(id = "canvas360",
                         component = "src",
                         attributes = img_assets[[img_index]]$reference())
              ))
    message("Now showing: ", img_assets[[img_index]]$id) 
  }

```

Calling `advance()` will trigger a transition to the next image. It should
transition instantly since all assets are loaded prior to the scene being shown.

## Streaming Position Data

In this scene we're going to look at streaming sea level height from R to a scene containing an island.

```{r}
library(r2vr)
island_model <- a_asset(id = "island",
                  src = "https://cdn.glitch.com/7cadb230-57b2-4aae-9de9-e60de097035e%2Fisland.gltf?1510323826393")

island <- a_entity(gltf_model = island_model,
                   scale = c(0.5, 0.5, 0.5),
                   position = c(0, 1, -3))

water <- a_entity(id = "water",
                  tag = "box",
                  width = 20,
                  depth = 20,
                  height = 5,
                  material = list(color = "#42B9F4",
                               opacity = 0.5,
                               transparent = TRUE,
                               shader = "flat"
                               )
                  )

the_scene <- a_scene(children = list(island, water),
                     websocket = TRUE)

the_scene$serve()

sea_level <- function(level){
  the_scene$send_messages(list(a_update(id = "water",
                                   component = "position",
                                   attributes = c(x = 0, y = level, z = 0))))
}

sea_level(10)



a_kill_all_scenes()


```


## Notifications from VR

## Old
```{r}
library(r2vr)

sources <- a_entity(js_sources = c("https://unpkg.com/aframe-event-set-component@^4.0.0/dist/aframe-event-set-component.min.js") )

box <- a_entity("box", id = "block",
                position = c(0, 1, -4),
                material = list(color = "red"),
                event_set__1 = list(`_event` = "switch_colour", material.color = "blue"),
                event_set__2 = list(`_event` = "rotate", rotation = c(0, 45, 0)))

my_scene <- a_scene(template = "basic",
                    children = list(box, sources),
                    websocket = TRUE)

my_scene$serve()

test_event <- list(a_event(id = "block",
                           event_name = "switch_colour",
                           event_detail = "any",
                           bubbles = FALSE),
                   a_event(id = "block",
                           event_name = "rotate",
                           event_detail = "any",
                           bubbles = FALSE)
                   )

my_scene$send_messages(test_event)

test_update <- list(a_update(id = "block",
                             component = "position",
                             attributes = list(x = 0, y = 0, z = -4)),
                    a_update(id = "block",
                             component = "color",
                             attributes = "green"))

my_scene$send_messages(test_update)

#try adding own handlers
my_scene$attach_ws_msg_hook(function(message, id){
  print(id)
  print(message)
})

a_kill_all_scenes()

```


