---
title: "Making a VR Scatterplot"
author: "Miles McBain"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This document describes two methods of using `r2vr` to create a VR scatter plot:
1. Generating a list of entity HTML elements, one for every data point.
2. Using a single entity that with a community developed A-Frame scatterplot component attached.


## Generating HTML entities
We're going to make a simple 3D scatter plot of `mpg` vs `wt` vs `hp`, coloured by `am` from the `mtcars` data. It will be made from scratch using `r2vr` so there's a few considerations:
What dimensions should the plot be? How do we scale the data to these dimensions? Can we apply labels that appear when the points are looked at?

Since we're going to be using the data to answer these questions we may as well create a function that returns a list of entities so we can re-use the code.

```{r}

library(r2vr)
library(purrr)
library(tibble)

a_scatter_ents <- function(x, y, z, colour = rep(1, length(x)), palette_fn = rainbow, sizes = rep(0.1, length(x)), labels, dimensions = c(2,2,2), ...){

  force(sizes)
  x_label <-  deparse(substitute(x))
  y_label <-  deparse(substitute(y))
  z_label <-  deparse(substitute(z))
  legend_label <- deparse(substitute(colour))

  colour_factor <- as.factor(colour)
  ent_colours <- palette_fn(nlevels(colour_factor))[colour_factor]

  range_scale <- function(a) (a - min(a, na.rm=TRUE)) / diff(range(a, na.rm=TRUE))
  x <- range_scale(x)
  y <- range_scale(y)
  z <- range_scale(z)

  positions <- cbind(x,y,z) * dimensions

  entity_data <-
    tibble::tibble(position = purrr::transpose(as.data.frame(positions)),
                       color = ent_colours,
                       radius = sizes,
                   label = labels)

  points <-
    purrr::pmap(entity_data, function(position, color, radius, label){

    id = gsub(" ", "", label)
    point <- a_entity(tag = "sphere", position = unlist(position), color = color,
                      radius = radius,
                      event_set__click =
                        list(`_event`= "click",
                             `_target`= "#labelview",
                             visible = TRUE,
                             value = label),
                      event_set__leave =
                        list(`_event`="mouseleave",
                             `_target`= "#labelview",
                             visible = FALSE,
                             value = label),
                      static_body = "",
                      js_sources = "https://unpkg.com/aframe-event-set-component@^4.0.0/dist/aframe-event-set-component.min.js")
    point
  })

  ## camera entity with cursor
  cursor <- a_entity(tag = "camera", position = c(0,1.6,3),
                     children = list(
                       a_entity(tag = "cursor", position = c(0,0,3)),
                       a_entity(tag = "text", id = "labelview",
                                scale = c(0.4, 0.4, 0.4),
                                color = "#000000",
                                align = "center",
                                position = c(0,-0.4,-1),
                                geometry= list(primitive = "box",
                                               width = 0.2,
                                               height = 0.2,
                                               depth = 0.2),
                                material = list(transparent = TRUE,
                                                opacity = 0))))
  ## make axis labels

  label_offset <- 0.1 * dimensions

  x_axis_label <- a_entity(tag = "text", value = x_label,
                           position = dimensions * c(0.5, 0.1, 0),
                           color = "#000000",
                           align = "center",
                           geometry = list(primitive = "box",
                                          width = 0.2,
                                          height = 0.2,
                                          depth = 0.2),
                           material = list(transparent = TRUE,
                                           opacity = 0))
  y_axis_label <- a_entity(tag = "text", value = y_label,
                           position = dimensions * c(0, 0.5, 0),
                           rotation = c(0, 45, 0),
                           color = "#000000",
                           align = "center",
                           geometry= list(primitive = "box",
                                          width = 0.2,
                                          height = 0.2,
                                          depth = 0.2),
                           material = list(transparent = TRUE,
                                           opacity = 0))
  z_axis_label <- a_entity(tag = "text", value = z_label,
                           position = dimensions * c(0, 0.1, 0.5),
                           rotation = c(0, 90, 0),
                           color = "#000000",
                           align = "center",
                           geometry= list(primitive = "box",
                                          width = 0.2,
                                          height = 0.2,
                                          depth = 0.2),
                           material = list(transparent = TRUE,
                                           opacity = 0))


  ## make each axis
  x_axis <- a_entity(line = list(start = c(0,0,0),
                                 end = c(dimensions[[1]], 0, 0),
                                 color = "#000000"),
                     children = list(x_axis_label))
  y_axis <- a_entity(line = list(start = c(0,0,0),
                                 end = c(0, dimensions[[2]], 0),
                                 color = "#000000"),
                     children = list(y_axis_label))
  z_axis <- a_entity(line = list(start = c(0,0,0),
                                 end = c(0, 0, dimensions[[3]]),
                                 color = "#000000"),
                     children = list(z_axis_label))
  ## make legend
  legend_levels <- levels(colour_factor)
  legend_colours <- palette_fn(nlevels(colour_factor))
  if(length(legend_levels > 1)){
    box_size = 0.2
    box_spacing = 0.2
    legend_position = c(dimensions[[1]] * 1.1, 0, 0)
    legend_ents <- purrr::imap(legend_levels,
                function(level, index){
                  a_entity(tag = "text", value = as.character(level),
                           position = c(0,
                                        index * (box_size + box_spacing), 0),
                           rotation = c(0, 0, 0),
                           color = "#000000",
                           align = "right",
                           anchor = "right",
                           text = list(xOffset = box_size*2),
                           geometry= list(primitive = "box",
                                          width = box_size,
                                          height = box_size,
                                          depth = box_size),
                           material = list(transparent = FALSE,
                                           color = legend_colours[[index]] )
                           )
                })
    ## Legend label
    legend_label <- a_entity(tag = "text", value = legend_label,
                             position = c(0, (box_size + box_spacing) *
                                                          (nlevels(colour_factor) + 1), 0),
                             rotation = c(0, 0, 0),
                             color = "#000000",
                             align = "center",
                             geometry= list(primitive = "box",
                                            width = box_size,
                                            height = box_size,
                                            depth = box_size),
                             material = list(transparent = TRUE,
                                             opacity = 0))
    plot_legend <- a_entity(position = legend_position,
                            children = c(legend_ents, legend_label))
  } else {
    plot_legend <- list()
  }

  ## make plot and add points
  plot <- a_entity(position = c(0,0.1,-3),  children = c(x_axis, y_axis,
                                                         z_axis, points,
                                                         plot_legend))

  kangaroo <- a_entity(tag = "gltf-model", position = c(1.5, 5, -1.5),
                       scale = c(0.2,0.2,0.2),
                       rotation = c(0, 180, 0),
                       dynamic_body="",
                       src = a_asset(id = "kangaroo",
                                     src = "tests/testthat/Kangaroo_01.gltf",
                                     parts = "tests/testthat/Kangaroo_01.bin"))

  my_scene <- a_scene(template = "basic",
                      title = "A scattering of cars",
                      children = c(cursor, plot, kangaroo),
                      js_sources = list("//cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.1.2/dist/aframe-physics-system.min.js"))

  my_scene$serve()
  my_scene
}

my_scene$stop()

my_scene <- a_scatter_ents(
  x = mtcars$hp,
  y = mtcars$mpg,
  z = mtcars$wt,
  colour = mtcars$am,
  pals::cols25,
  labels = row.names(mtcars),
  dimensions = c(3,3,3))



debug(a_scatter_ents)



```

## Using a community component

```

```

